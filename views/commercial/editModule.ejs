<div class="container-fluid">
    <div class="row">
        <!--左边链接等-->
        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-12">
            <div class="panel panel-default text-center">
                <div class="panel-heading">
                    <h3 class="panel-title" id="activityTitle">
                    </h3>
                </div>
                <div class="panel-body">
                    <ul>
                        <li><a href="#" onclick="redirect('/commercial/editActivity')" > 编辑活动概要</a></li>
                        <li><a href="#" onclick="redirect('/commercial/editItem')">编辑商品</a></li>
                        <li><a href="#" onclick="redirect('/commercial/editModule')">编辑模块</a></li>
                        <li><a href="#" onclick="redirect('/commercial/editItemsInModule')">编辑模块中商品</a></li>
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="row">
                        <button class="button button-primary" onclick="goback()">返回</button>
                    </div>
                </div>
            </div>
        </div>
        <!--右边活动编辑区域-->
        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-12">
            <!--模块列表-->
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">
                                    新建/更新模块信息
                                </h3>
                            </div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class=" col-lg-3 col-md-3 col-sm-3 col-xs-8">
                                        <div class="input-group">
                                            <input id="moduleName" type="text" class="form-control" placeholder="输入模块名"/>
                                            <span class="input-group-addon"><i class="fa fa-keyboard-o"></i></span>
                                        </div>
                                    </div>
                                    <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                                        <button class="button button-primary button-small" onclick="addModule()">添加</button>
                                    </div>
                                </div>
                                <br/>
                                <div class="row text-left">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        模块列表
                                        <hr/>
                                        <table class="table table-bordered" id="_table">
                                            <thead>
                                            <tr>
                                                <td>模块名</td>
                                                <td>启用</td>
                                                <td>创建日期</td>
                                                <td>操作</td>
                                            </tr>
                                            </thead>
                                            <tbody id="_body">

                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-footer">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<!--<script src="/javascripts/ckeditor/ckeditor.js"></script>-->
<script>
    var _moduleList;

    //加载模块信息
    $.post('/commercial/getModuleList',
            {'activityID':getQueryStringByName('actid')},
            function(data){
                if(data.succeed)
                {
                    _moduleList=data.list;
                    init();
                }
                else
                {
                    //弹出错误信息
                    alert('加载活动信息时出错，原因：'+data.message);
                }

            });

    //初始化显示已经有的模块信息
    function init()
    {
        var table=document.getElementById('_table');

        for(var i in _moduleList)
        {
            var row=table.insertRow(table.rows.length);
            var td1=row.insertCell(row.cells.length);
            td1.innerHTML=_moduleList[i].moduleName;

            var td2=row.insertCell(row.cells.length);
            var cb=document.createElement('input');
            cb.setAttribute('type','checkbox');
            cb.setAttribute('checked',_moduleList[i].enabled?'checked':'');
            cb.setAttribute('onclick',"checkChange(this,'"+_moduleList[i].moduleID+"')");
            td2.appendChild(cb);

            var td3=row.insertCell(row.cells.length);
            td3.innerHTML=new Date(_moduleList[i].creationDate).toLocaleDateString();

            var td4=row.insertCell(row.cells.length);
            var a=document.createElement('a');
            a.setAttribute('class','button button-caution button-tiny');
            a.setAttribute('onclick',"delModule('"+_moduleList[i].moduleID+"')");
            a.innerHTML='删除';
            td4.appendChild(a);
        }
    }

    //更新module的启用状态
    function checkChange(obj,moduleID)
    {
        $.post('/commercial/updateModule',
                {'module':{'moduleID':moduleID,'enabled':obj.checked,'lastUpdateDate':new Date()}},
                function(data){
                    if(data.succeed)
                    {
                        return;
                    }
                    else
                    {
                        //弹出错误信息
                        alert('更新模块信息时失败，原因：'+data.message);
                    }

                });
    }

    <!-- 判断模块名是否已存在-->
    function isModuleNameExists(name)
    {
        for(var i in _moduleList)
        {
            if(_moduleList[i].moduleName==name)
            {
                return true;
            }
        }
        return false;
    }

    //新增加一个模块
    function addModule()
    {
        var name=$('#moduleName').val();
        if(name=="")
        {
            return ;
        }
        else
        {
            if(isModuleNameExists(name))
            {
                alert('模块名称已存在列表中，请核对');
                return ;
            }
            else
            {
                //保存到db并保存到_moduleList
                var module={
                    'moduleName':name,
                    'creationDate':new Date(),
                    'enabled':true,
                    'activityID':getQueryStringByName('actid'),
                    'moduleID':''
                };

                $.post('/commercial/saveModule',
                        {'module':module},
                        function(data){
                            if(data.succeed)
                            {

                                //db保存成功后在页面中新添加一行
                                module.moduleID=data._id;
                                addToTable(module);
                                //向_moduleLIst中同步添加项
                                _moduleList.push(module);
                            }
                            else
                            {
                                //弹出错误信息
                                alert(data.message);
                            }

                        });
            }

        }
    }

    //在dom中添加一行
    function addToTable(module)
    {
        var table=document.getElementById('_table');
        var row=table.insertRow(table.rows.length);
        var td1=row.insertCell(row.cells.length);
        td1.innerHTML=module.moduleName;

        var td2=row.insertCell(row.cells.length);
        var cb=document.createElement('input');
        cb.setAttribute('type','checkbox');
        cb.setAttribute('checked',module.enabled);
        cb.setAttribute('onclick',"checkChange(this,'"+module.moduleID+"')");
        td2.appendChild(cb);

        var td3=row.insertCell(row.cells.length);
        td3.innerHTML=new Date(module.creationDate).toLocaleDateString();

        var td4=row.insertCell(row.cells.length);
        var a=document.createElement('a');
        a.setAttribute('class','button button-caution button-tiny');
        a.setAttribute('onclick',"delModule('"+module.moduleID+"')");
        a.innerHTML='删除';
        td4.appendChild(a);
    }

    //删除新增加的模块
    function delModule(moduleID)
    {
        if(confirm('删除模块将会同时删除里面的所有内容，确定继续？'))
        {

        }
    }

    //清除上传的宣传图片
    function clearFile(file)
    {
        document.getElementById(file).innerHTML='';
    }

    //返回前一个页面
    function goback()
    {
        history.go(-1);
    }

    //链接跳转
    function redirect(tag)
    {
        go(tag+'?actid='+getQueryStringByName('actid'));
    }

    //保存当前页面数据
    function save()
    {
        //验证用户活动名
        var name=$('#activityName').val();
        if(name.trim()=='' || name.trim()==null)
        {
            alert('请输入您的活动名称!');
            return;
        }

        var exp =new RegExp('^[a-zA-Z0-9\\u4E00-\\u9FA5]{1,10}$');//验证活动名是否汉字、字母或数字的组合，其他字符不允许
        if(!exp.test($('#activityName').val()))
        {
            alert('请输入10个以内的字符作为活动名，汉字、字母及数字的组合都可以!');
            return;
        }

        //验证用户活动描述
        var desc=$('#activityDesc').val();
        if(desc.trim()=='' || desc.trim()==null)
        {
            alert('请输入您的活动描述!');
            return;
        }

        var exp =new RegExp('^[a-zA-Z0-9\\u4E00-\\u9FA5]{1,100}$');//验证活动描述是否汉字、字母或数字的组合，其他字符不允许
        if(!exp.test(desc))
        {
            alert('请输入100个以内的字符作为活动描述，汉字、字母及数字的组合都可以!');
            return;
        }

        //验证用户活动联系信息
        var contact=$('#contactInfo').val();
        if(contact.trim()=='' || contact.trim()==null)
        {
            alert('请输入您的联系信息!');
            return;
        }

        var exp =new RegExp('^[a-zA-Z0-9\\u4E00-\\u9FA5]{1,50}$');//验证活动描述是否汉字、字母或数字的组合，其他字符不允许
        if(!exp.test(contact))
        {
            alert('请输入50个以内的字符作为联系信息!');
            return;
        }


        if(!document.getElementById('enable').checked)
        {
            if(!confirm('注意：您尚未选择启用此活动，内容将不公开显示，继续？'))
            {
                return;
            }
        }


        //post数据，进行保存
        var data={
            'activityID':getQueryStringByName('actid'),
            'activityDesc':desc,
            'enabled':document.getElementById('enable').checked?true:false,
            'contactInfo':contact,
            'pic1':$('#file1Path').val()==null?'':$('#file1Path').val(),
            'pic1Desc':$('#fileText1').val()==null?'':$('#fileText1').val(),
            'pic2':$('#file2Path').val()==null?'':$('#file2Path').val(),
            'pic2Desc':$('#fileText2').val()==null?'':$('#fileText2').val(),
            'pic3':$('#file3Path').val()==null?'':$('#file3Path').val(),
            'pic3Desc':$('#fileText3').val()==null?'':$('#fileText3').val()
        };

        $.post('/commercial/updateActivity',
                {'data':data},
                function(data){
                    if(data.succeed)
                    {
                        alert(data.message);
                    }
                    else
                    {
                        //弹出错误信息
                        alert(data.message);
                    }

                });

    }


</script>



